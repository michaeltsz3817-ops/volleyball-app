import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  serverTimestamp,
  doc,
  deleteDoc
} from 'firebase/firestore';
import { 
  Trophy, 
  History, 
  Plus, 
  Users, 
  Trash2, 
  Camera, 
  Calendar as CalendarIcon,
  Medal,
  Crown,
  TrendingDown,
  ChevronLeft,
  ChevronRight
} from 'lucide-react';

// =================================================================
// ä½ çš„ Firebase Config (å·²å¡«å¥½)
// =================================================================

const firebaseConfig = {
  apiKey: "AIzaSyCnKewEU8m4Kf_W09-3eednqHBV-4ZFKr4",
  authDomain: "office-bets-9b5bc.firebaseapp.com",
  projectId: "office-bets-9b5bc",
  storageBucket: "office-bets-9b5bc.firebasestorage.app",
  messagingSenderId: "354145606988",
  appId: "1:354145606988:web:fb37bb075f7775de1603e9",
  measurementId: "G-9JRSNXCXBJ"
};

// =================================================================

// Initialize Firebase
let app, auth, db;
try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch (e) {
  console.error("Firebase Init Error:", e);
}

const appId = 'volleyball-app-v2';
const MATCHES_COLLECTION = 'volleyball_matches';
const USERS_COLLECTION = 'volleyball_users';

// --- Helper: Image Resize ---
const resizeImage = (file) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 300;
        const scaleSize = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scaleSize;
        const ctx = canvas.getContext('2d');
        if (ctx) {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
        }
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });
};

// --- Helper: Date Formatting ---
const getFormattedDate = (date) => {
  if (!date) return '';
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
};

const getDisplayDate = (dateString) => {
  const date = new Date(dateString);
  const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  return {
    day: date.getDate(),
    weekday: days[date.getDay()],
    full: `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
  };
};

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [users, setUsers] = useState([]);
  const [matches, setMatches] = useState([]);
  const [loading, setLoading] = useState(true);

  // Calendar State
  const [selectedDate, setSelectedDate] = useState(getFormattedDate(new Date())); 
  // Dashboard Month Filter
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7)); 

  // Game Input
  const [baseRate, setBaseRate] = useState(10);
  const [selectedWinners, setSelectedWinners] = useState([]);
  const [selectedLosers, setSelectedLosers] = useState([]);

  // Profile Input
  const [newUserName, setNewUserName] = useState('');
  const [userPhoto, setUserPhoto] = useState(null);
  const fileInputRef = useRef(null);

  // --- Auth & Data ---
  useEffect(() => {
    const init = async () => {
        try {
            await signInAnonymously(auth);
        } catch (error) {
            console.error("Auth Error:", error);
        }
    };
    init();
    
    if (auth) {
        onAuthStateChanged(auth, u => setUser(u));
    }
  }, []);

  useEffect(() => {
    if (!user || !db) return;
    
    // è®€å– Users
    const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', USERS_COLLECTION), (snap) => {
      setUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    }, (err) => console.error("User fetch error:", err));

    // è®€å– Matches
    const unsubMatches = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', MATCHES_COLLECTION), (snap) => {
      const data = snap.docs.map(d => ({ 
        id: d.id, 
        ...d.data(),
        createdAt: d.data().createdAt?.toDate ? d.data().createdAt.toDate() : new Date()
      }));
      setMatches(data.sort((a, b) => b.createdAt - a.createdAt));
      setLoading(false);
    }, (err) => console.error("Match fetch error:", err));

    return () => { unsubUsers(); unsubMatches(); };
  }, [user]);

  // --- Logic: Leaderboard Stats (Monthly) ---
  const leaderboardStats = useMemo(() => {
    const stats = {};
    users.forEach(u => stats[u.id] = { ...u, net: 0, wins: 0, losses: 0, games: 0 });

    matches.forEach(m => {
      // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ m.createdAt æ˜¯æ—¥æœŸç‰©ä»¶
      const d = m.createdAt instanceof Date ? m.createdAt : new Date();
      if (d.toISOString().slice(0, 7) !== selectedMonth) return;
      
      const pot = (m.baseRate || 0) * (m.losers?.length || 0);
      const winShare = m.winners?.length ? pot / m.winners.length : 0;

      m.winners?.forEach(uid => {
        if (stats[uid]) {
          stats[uid].net += winShare;
          stats[uid].wins++;
          stats[uid].games++;
        }
      });
      m.losers?.forEach(uid => {
        if (stats[uid]) {
          stats[uid].net -= (m.baseRate || 0);
          stats[uid].losses++;
          stats[uid].games++;
        }
      });
    });

    return Object.values(stats)
      .filter(p => p.games > 0)
      .sort((a, b) => b.net - a.net);
  }, [users, matches, selectedMonth]);

  // --- Logic: Daily History Filter ---
  const dailyMatches = useMemo(() => {
    return matches.filter(m => {
        const d = m.createdAt instanceof Date ? m.createdAt : new Date();
        return getFormattedDate(d) === selectedDate;
    });
  }, [matches, selectedDate]);

  // --- Titles Logic ---
  const getPlayerTitle = (rank, total, net) => {
    if (total < 3) return null;
    if (rank === 0 && net > 0) return { title: "æ’çƒä¹‹ç¥", icon: <Crown className="w-3 h-3 text-yellow-600" />, style: "bg-yellow-100 text-yellow-800 border-yellow-200" };
    if (rank === 1 && net > 0) return { title: "äºŒç•¶å®¶", icon: <Medal className="w-3 h-3 text-blue-600" />, style: "bg-blue-100 text-blue-800 border-blue-200" };
    if (rank === total - 1 && net < 0) return { title: "æ…ˆå–„çƒç‹", icon: <TrendingDown className="w-3 h-3 text-red-600" />, style: "bg-red-100 text-red-800 border-red-200" };
    return null;
  };

  // --- Date Strip Generation ---
  const dateStrip = useMemo(() => {
    const dates = [];
    for (let i = -6; i <= 0; i++) {
      const d = new Date();
      d.setDate(d.getDate() + i);
      dates.push(getFormattedDate(d));
    }
    return dates;
  }, []);

  // --- Actions ---
  const toggleSelection = (id, type) => {
    if (type === 'winner') {
      if (selectedLosers.includes(id)) setSelectedLosers(prev => prev.filter(uid => uid !== id));
      setSelectedWinners(prev => prev.includes(id) ? prev.filter(uid => uid !== id) : [...prev, id]);
    } else {
      if (selectedWinners.includes(id)) setSelectedWinners(prev => prev.filter(uid => uid !== id));
      setSelectedLosers(prev => prev.includes(id) ? prev.filter(uid => uid !== id) : [...prev, id]);
    }
  };

  const submitGame = async () => {
    if (!selectedWinners.length || !selectedLosers.length) return alert("è«‹é¸æ“‡äººå");
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', MATCHES_COLLECTION), {
        baseRate,
        winners: selectedWinners,
        losers: selectedLosers,
        createdAt: serverTimestamp()
      });
      setSelectedWinners([]); setSelectedLosers([]); setActiveTab('dashboard');
    } catch (e) { 
        console.error(e);
        alert("è¨˜éŒ„å¤±æ•—: " + e.message); 
    }
  };

  const handleCreateUser = async () => {
    if (!newUserName.trim()) return;
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', USERS_COLLECTION), {
        name: newUserName.trim(),
        photo: userPhoto,
        createdAt: serverTimestamp()
        });
        setNewUserName(''); setUserPhoto(null);
    } catch (e) {
        alert("æ–°å¢å¤±æ•—: " + e.message);
    }
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400 font-bold">è¼‰å…¥æ’çƒæ•¸æ“šä¸­...</div>;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 pb-24 font-sans select-none">
      
      {/* HEADER WITH CALENDAR STRIP */}
      <div className="bg-gradient-to-b from-blue-700 to-blue-600 text-white rounded-b-3xl shadow-lg pt-safe-top sticky top-0 z-20">
        <div className="px-5 py-4 flex justify-between items-center">
          <div>
            <h1 className="text-xl font-bold flex items-center gap-2">
              ğŸ æ’çƒæ•¸ç°¿ <span className="text-blue-200 text-xs bg-blue-800 px-2 py-0.5 rounded-full">Pro</span>
            </h1>
            <p className="text-blue-100 text-xs mt-0.5 opacity-80">ä»Šæ—¥æˆ°æ³: {dailyMatches.length} å ´</p>
          </div>
          <button onClick={() => setActiveTab('profiles')} className="bg-blue-800/50 p-2 rounded-full hover:bg-blue-800 backdrop-blur-sm">
             <Users className="w-5 h-5 text-blue-100" />
          </button>
        </div>

        {/* Date Selector Strip */}
        <div className="flex overflow-x-auto px-4 pb-4 gap-2 scrollbar-hide snap-x">
          {dateStrip.map(dateStr => {
            const { day, weekday } = getDisplayDate(dateStr);
            const isSelected = selectedDate === dateStr;
            const isToday = dateStr === getFormattedDate(new Date());
            return (
              <button
                key={dateStr}
                onClick={() => setSelectedDate(dateStr)}
                className={`snap-center flex flex-col items-center justify-center min-w-[3.5rem] h-16 rounded-2xl transition-all duration-300 ${
                  isSelected 
                    ? 'bg-white text-blue-600 shadow-lg transform -translate-y-1' 
                    : 'bg-blue-800/40 text-blue-100 hover:bg-blue-800/60'
                }`}
              >
                <span className="text-[10px] font-medium opacity-80">{isToday ? 'ä»Šæ—¥' : weekday}</span>
                <span className="text-lg font-bold leading-none">{day}</span>
              </button>
            );
          })}
        </div>
      </div>

      <main className="px-4 py-6 max-w-lg mx-auto">

        {/* --- DASHBOARD (LEADERBOARD) --- */}
        {activeTab === 'dashboard' && (
          <div className="animate-fade-in space-y-5">
            <div className="flex justify-between items-center">
               <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                 <Trophy className="w-5 h-5 text-yellow-500 fill-current" /> 
                 <select 
                    value={selectedMonth} 
                    onChange={e => setSelectedMonth(e.target.value)}
                    className="bg-transparent font-bold focus:outline-none cursor-pointer"
                 >
                   {[0, -1, -2].map(offset => {
                      const d = new Date();
                      d.setMonth(d.getMonth() + offset);
                      const val = d.toISOString().slice(0, 7);
                      return <option key={val} value={val}>{d.getMonth() + 1}æœˆé¾è™æ¦œ</option>
                   })}
                 </select>
               </h2>
            </div>

            <div className="space-y-4">
              {leaderboardStats.length === 0 ? (
                <div className="text-center py-12 bg-white rounded-2xl border border-dashed border-slate-200">
                  <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <Trophy className="w-8 h-8 text-slate-300" />
                  </div>
                  <p className="text-slate-400 text-sm">ä»Šå€‹æœˆæš«æ™‚æœªé–‹æ³¢</p>
                </div>
              ) : (
                leaderboardStats.map((player, index) => {
                  const title = getPlayerTitle(index, leaderboardStats.length, player.net);
                  const isTop = index === 0 && player.net > 0;
                  
                  return (
                    <div 
                      key={player.id} 
                      className={`relative flex items-center justify-between p-4 rounded-2xl transition-all ${
                        isTop 
                          ? 'bg-gradient-to-r from-yellow-50 to-white border border-yellow-200 shadow-yellow-100 shadow-lg scale-[1.02]' 
                          : 'bg-white border border-slate-100 shadow-sm'
                      }`}
                    >
                      {/* Rank Badge */}
                      <div className={`absolute -left-2 top-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold border-2 border-white shadow-sm ${
                        index === 0 ? 'bg-yellow-400 text-white' : 
                        index === 1 ? 'bg-slate-300 text-white' : 
                        index === 2 ? 'bg-amber-600 text-white' : 'bg-slate-100 text-slate-500'
                      }`}>
                        {index + 1}
                      </div>

                      <div className="flex items-center gap-4 pl-2">
                         <div className={`w-12 h-12 rounded-full bg-slate-100 p-0.5 relative ${isTop ? 'ring-2 ring-yellow-400' : ''}`}>
                            <img src={player.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PC9zdmc+'} className="w-full h-full object-cover rounded-full bg-slate-200" alt="" />
                            {isTop && <div className="absolute -top-2 -right-1 text-lg animate-bounce">ğŸ‘‘</div>}
                         </div>
                         <div>
                            <div className="flex items-center gap-2">
                               <span className="font-bold text-slate-800">{player.name}</span>
                               {title && (
                                 <span className={`text-[10px] px-1.5 py-0.5 rounded-md flex items-center gap-1 font-bold border ${title.style}`}>
                                   {title.icon} {title.title}
                                 </span>
                               )}
                            </div>
                            <div className="text-xs text-slate-400 mt-1 flex gap-2">
                               <span className="font-medium text-green-600">{player.wins}å‹</span>
                               <span>/</span>
                               <span className="font-medium text-red-500">{player.losses}è² </span>
                            </div>
                         </div>
                      </div>

                      <div className={`text-xl font-black font-mono tracking-tight ${player.net >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                        {player.net > 0 && '+'}{player.net.toFixed(0)}
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        )}

        {/* --- GAME INPUT --- */}
        {activeTab === 'game' && (
           <div className="animate-zoom-in pb-10">
              <h2 className="text-center font-bold text-slate-800 mb-6 text-xl">æ–°ä¸€å±€çµç®—</h2>

              {/* Rate Selector */}
              <div className="bg-white p-2 rounded-2xl shadow-sm border border-slate-100 flex mb-8">
                {[10, 20, 30].map(r => (
                  <button 
                    key={r} 
                    onClick={() => setBaseRate(r)}
                    className={`flex-1 py-3 rounded-xl font-bold text-lg transition-all ${
                      baseRate === r 
                      ? 'bg-blue-600 text-white shadow-md' 
                      : 'text-slate-400 hover:bg-slate-50'
                    }`}
                  >
                    ${r}
                  </button>
                ))}
              </div>

              {/* Player Grid */}
              <div className="grid grid-cols-2 gap-4">
                 {/* Winners */}
                 <div className="bg-green-50/50 p-3 rounded-3xl border border-green-100">
                    <div className="text-green-700 font-bold text-center mb-3 flex items-center justify-center gap-2">
                      <Medal className="w-5 h-5" /> è´å®¶ ({selectedWinners.length})
                    </div>
                    <div className="space-y-2">
                       {users.map(u => (
                          <button
                            key={u.id}
                            onClick={() => toggleSelection(u.id, 'winner')}
                            disabled={selectedLosers.includes(u.id)}
                            className={`w-full p-2 rounded-xl flex items-center gap-3 transition-all border ${
                               selectedWinners.includes(u.id)
                               ? 'bg-green-500 text-white border-green-600 shadow-green-200 shadow-md transform scale-[1.02]'
                               : selectedLosers.includes(u.id)
                                 ? 'opacity-20 bg-white border-transparent'
                                 : 'bg-white border-slate-100 hover:border-green-300'
                            }`}
                          >
                             <img src={u.photo || ''} className="w-8 h-8 rounded-full bg-slate-200 object-cover" />
                             <span className="font-bold text-sm truncate">{u.name}</span>
                          </button>
                       ))}
                    </div>
                 </div>

                 {/* Losers */}
                 <div className="bg-red-50/50 p-3 rounded-3xl border border-red-100">
                    <div className="text-red-600 font-bold text-center mb-3 flex items-center justify-center gap-2">
                       <TrendingDown className="w-5 h-5" /> è¼¸å®¶ ({selectedLosers.length})
                    </div>
                    <div className="space-y-2">
                       {users.map(u => (
                          <button
                            key={u.id}
                            onClick={() => toggleSelection(u.id, 'loser')}
                            disabled={selectedWinners.includes(u.id)}
                            className={`w-full p-2 rounded-xl flex items-center gap-3 transition-all border ${
                               selectedLosers.includes(u.id)
                               ? 'bg-red-500 text-white border-red-600 shadow-red-200 shadow-md transform scale-[1.02]'
                               : selectedWinners.includes(u.id)
                                 ? 'opacity-20 bg-white border-transparent'
                                 : 'bg-white border-slate-100 hover:border-red-300'
                            }`}
                          >
                             <img src={u.photo || ''} className="w-8 h-8 rounded-full bg-slate-200 object-cover" />
                             <span className="font-bold text-sm truncate">{u.name}</span>
                          </button>
                       ))}
                    </div>
                 </div>
              </div>

              {/* Submit Button Float */}
              {selectedWinners.length > 0 && selectedLosers.length > 0 && (
                <div className="fixed bottom-24 left-4 right-4 animate-slide-up z-30">
                  <button 
                    onClick={submitGame}
                    className="w-full bg-slate-900 text-white p-4 rounded-2xl shadow-xl flex items-center justify-between hover:bg-black transition-colors"
                  >
                    <div className="text-left">
                       <div className="text-xs text-slate-400">æœ¬å±€çµç®—</div>
                       <div className="font-bold text-lg">è´å®¶æ¯äººæ”¶ <span className="text-green-400">${(baseRate * selectedLosers.length / selectedWinners.length).toFixed(1)}</span></div>
                    </div>
                    <div className="bg-white text-slate-900 px-4 py-2 rounded-xl font-bold text-sm">
                       ç¢ºèª
                    </div>
                  </button>
                </div>
              )}
           </div>
        )}

        {/* --- HISTORY TAB --- */}
        {activeTab === 'history' && (
           <div className="animate-fade-in space-y-4">
              <div className="flex items-center justify-between mb-2">
                 <h2 className="text-lg font-bold text-slate-800">
                    {getDisplayDate(selectedDate).full} è¨˜éŒ„
                 </h2>
                 <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-lg">
                    {dailyMatches.length} å ´
                 </span>
              </div>
              
              {dailyMatches.length === 0 ? (
                 <div className="bg-white p-8 rounded-2xl text-center shadow-sm">
                    <CalendarIcon className="w-10 h-10 text-slate-200 mx-auto mb-2" />
                    <p className="text-slate-400">é€™å¤©æ²’æœ‰æ‰“æ³¢</p>
                 </div>
              ) : (
                 dailyMatches.map((m, idx) => (
                    <div key={m.id} className="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm relative overflow-hidden group">
                       <div className="absolute top-0 left-0 w-1 h-full bg-slate-200"></div>
                       <div className="flex justify-between items-start mb-3 pl-3">
                          <span className="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">
                             Game {dailyMatches.length - idx}
                          </span>
                          <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', MATCHES_COLLECTION, m.id))} className="text-slate-300 hover:text-red-500">
                             <Trash2 className="w-4 h-4" />
                          </button>
                       </div>
                       
                       <div className="flex gap-4 pl-3">
                          <div className="flex-1">
                             <div className="text-xs text-slate-400 mb-1">è´å®¶ (+${((m.baseRate * m.losers.length) / m.winners.length).toFixed(1)})</div>
                             <div className="flex flex-wrap gap-1">
                                {m.winners.map(uid => {
                                   const u = users.find(user => user.id === uid);
                                   return <span key={uid} className="text-xs font-bold text-green-700 bg-green-50 px-1.5 py-0.5 rounded">{u?.name}</span>
                                })}
                             </div>
                          </div>
                          <div className="flex-1">
                             <div className="text-xs text-slate-400 mb-1">è¼¸å®¶ (-${m.baseRate})</div>
                             <div className="flex flex-wrap gap-1">
                                {m.losers.map(uid => {
                                   const u = users.find(user => user.id === uid);
                                   return <span key={uid} className="text-xs font-bold text-red-700 bg-red-50 px-1.5 py-0.5 rounded">{u?.name}</span>
                                })}
                             </div>
                          </div>
                       </div>
                    </div>
                 ))
              )}
           </div>
        )}

        {/* --- PROFILES --- */}
        {activeTab === 'profiles' && (
           <div className="animate-fade-in">
              <h2 className="text-lg font-bold text-slate-800 mb-4">éšŠå“¡ç®¡ç†</h2>
              <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6">
                 <div className="flex gap-4 items-center">
                    <button onClick={() => fileInputRef.current?.click()} className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center border-2 border-dashed border-slate-300 hover:border-blue-400 overflow-hidden shrink-0">
                       {userPhoto ? <img src={userPhoto} className="w-full h-full object-cover" /> : <Camera className="w-6 h-6 text-slate-400" />}
                    </button>
                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={async (e) => {
                       if(e.target.files && e.target.files[0]) setUserPhoto(await resizeImage(e.target.files[0]))
                    }} />
                    <div className="flex-1 space-y-2">
                       <input value={newUserName} onChange={e => setNewUserName(e.target.value)} placeholder="æ–°éšŠå“¡åå­—" className="w-full bg-slate-50 p-2 rounded-lg text-sm border-none focus:ring-2 focus:ring-blue-500" />
                       <button onClick={handleCreateUser} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold w-full">åŠ å…¥</button>
                    </div>
                 </div>
              </div>

              <div className="grid grid-cols-3 gap-3">
                 {users.map(u => (
                    <div key={u.id} className="bg-white p-3 rounded-2xl border border-slate-100 flex flex-col items-center gap-2 relative group shadow-sm">
                       <img src={u.photo} className="w-12 h-12 rounded-full bg-slate-200 object-cover" />
                       <span className="text-xs font-bold text-slate-700 text-center truncate w-full">{u.name}</span>
                       <button onClick={() => confirm('Del?') && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', USERS_COLLECTION, u.id))} className="absolute top-1 right-1 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100">
                          <Trash2 className="w-3 h-3" />
                       </button>
                    </div>
                 ))}
              </div>
           </div>
        )}

      </main>

      {/* BOTTOM NAV */}
      <nav className="fixed bottom-0 w-full bg-white border-t border-slate-100 pb-safe pt-2 px-6 z-40 rounded-t-3xl shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)]">
        <div className="max-w-lg mx-auto flex justify-between items-end pb-4">
          <NavBtn active={activeTab==='dashboard'} onClick={() => setActiveTab('dashboard')} icon={<Trophy />} label="é¾è™æ¦œ" />
          <NavBtn active={activeTab==='history'} onClick={() => {
             setActiveTab('history');
             setSelectedDate(getFormattedDate(new Date())); // Switch to today when clicking history
          }} icon={<History />} label="ä»Šæ—¥è¨˜éŒ„" />
          
          <div className="relative -top-6">
             <button 
               onClick={() => setActiveTab('game')}
               className={`w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-transform hover:scale-105 active:scale-95 ${activeTab === 'game' ? 'bg-slate-800 text-white' : 'bg-blue-600 text-white shadow-blue-200'}`}
             >
                <Plus className="w-8 h-8" strokeWidth={3} />
             </button>
          </div>

          <div className="w-10"></div> {/* Spacer for symmetry with 4 items if needed, or keeping it centered */}
          <NavBtn active={activeTab==='profiles'} onClick={() => setActiveTab('profiles')} icon={<Users />} label="éšŠå“¡" />
        </div>
      </nav>

      <style>{`
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe-top { padding-top: env(safe-area-inset-top, 20px); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-zoom-in { animation: zoomIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      `}</style>
    </div>
  );
}

const NavBtn = ({ active, onClick, icon, label }) => (
  <button 
    onClick={onClick} 
    className={`flex flex-col items-center gap-1 w-16 transition-colors ${active ? 'text-blue-600' : 'text-slate-300 hover:text-slate-400'}`}
  >
    {React.cloneElement(icon, { size: 24, strokeWidth: active ? 2.5 : 2 })}
    <span className="text-[10px] font-bold tracking-tight">{label}</span>
  </button>
);


